\input{preamble.tex}

\title{Отчет по лабораторной работе № 9. \\Настройка POP3/IMAP сервера}
\author{Сущенко Алина \\ НПИбд-01-23}
\date{2024}

\begin{document}

\maketitle
\newpage

\tableofcontents

\newpage
\section{Цель работы}
Приобретение практических навыков по установке и простейшему конфигурированию POP3/IMAP-сервера.

\newpage
\section{Выполнение работы}

\subsection{Установка Dovecot}
\begin{enumerate}
\item На виртуальной машине \texttt{server} вошли под нашим пользователем и открыли терминал. Перешли в режим администратора:
  \begin{minted}{bash}
    sudo -i
  \end{minted}
\item Установили необходимые для работы пакеты:
  \begin{minted}{bash}
    dnf -y install dovecot telnet
  \end{minted}
\end{enumerate}
\subsection{Настройка dovecot}
\begin{enumerate}
\item В конфигурационном файле \texttt{/etc/dovecot/dovecot.conf} прописали список почтовых протоколов, по которым разрешено работать Dovecot (Рис. \ref{01}):
  \begin{minted}{bash}
    protocols = imap pop3
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/01.png}
    \captionof{figure}{Разрешенные почтовые протоколы в конфигурации Dovecot.}
    \label{01}
\end{center}

\item В конфигурационном файле \texttt{/etc/dovecot/conf.d/10-auth.conf} проверили, что указан метод аутентификации \texttt{plain} (Рис. \ref{02}):
\begin{minted}{bash}
  auth_mechanisms = plain
\end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/02.png}
    \captionof{figure}{Указание метода аутентификации \texttt{plain}.}
    \label{02}
\end{center}

\item В конфигурационном файле 
\texttt{/etc/dovecot/conf.d/auth-system.conf.ext} проверили, что для поиска пользователей и их паролей используется \texttt{pam} и файл \texttt{passwd} (Рис. \ref{03} и \ref{04}):
  \begin{minted}{bash}
    passdb {
      driver = pam
    }
    userdb {
      driver = passwd
    }
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/03.png}
    \captionof{figure}{Использование файла \texttt{passwd} для поиска паролей.}
    \label{03}
\end{center}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/04.png}
    \captionof{figure}{Использование \texttt{pam} пользователей.}
    \label{04}
\end{center}

\item В конфигурационном файле \texttt{/etc/dovecot/conf.d/10-mail.conf} настроили месторасположение почтовых ящиков пользователей (Рис. \ref{05}):
  \begin{minted}{bash}
    mail_location = maildir:~/Maildir
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/05.png}
    \captionof{figure}{Настройка месторасположения почтовых ящиков пользователей.}
    \label{05}
\end{center}

\item В Postfix задали каталог для доставки почты:
  \begin{minted}{bash}
    postconf -e 'home_mailbox = Maildir/'
  \end{minted}
\item Сконфигурировали межсетевой экран, разрешив работать службам протоколов POP3 и IMAP (Рис. \ref{06}):
  \begin{minted}{bash}
    firewall-cmd --get-services
    firewall-cmd --add-service=pop3 --permanent
    firewall-cmd --add-service=pop3s --permanent
    firewall-cmd --add-service=imap --permanent
    firewall-cmd --add-service=imaps --permanent
    firewall-cmd --reload
    firewall-cmd --list-services
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/06.png}
    \captionof{figure}{Настройка межсетевого экрана для работы служб протоколов POP3 и IMAP.}
    \label{06}
\end{center}

\item Восстановили контекст безопасности в SELinux:
  \begin{minted}{bash}
    restorecon -vR /etc
  \end{minted}
\begin{center}
    \label{07}
\end{center}

\item Перезапустили Postfix и запустили Dovecot (Рис. \ref{08}):
  \begin{minted}{bash}
    systemctl restart postfix
    systemctl enable dovecot
    systemctl start dovecot
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/07.png}
    \captionof{figure}{Перезапуск Postfix и Dovecot.}
    \label{08}
\end{center}
\end{enumerate}


\subsection{Проверка работы Dovecot}
\begin{enumerate}
\item На дополнительном терминале виртуальной машины \texttt{server} запустили мониторинг работы почтовой службы (Рис. \ref{09}):
\begin{minted}{bash}
  tail -f /var/log/maillog
\end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/08.png}
    \captionof{figure}{Запуск мониторинга работы почтовой службы.}
    \label{09}
\end{center}

\item На терминале сервера для просмотра имеющейся почты использовали  (Рис. \ref{10})
  \begin{minted}{bash}
    MAIL=~/Maildir mail
  \end{minted}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/09.png}
    \captionof{figure}{Просмотр имеющейся почты на сервере.}
    \label{10}
\end{center}
\item На виртуальной машине \texttt{client} вошли под пользователем и открыли терминал. Перешли в режим суперпользователя:
  \begin{minted}{bash}
    sudo -i
  \end{minted}

\item Установили почтовый клиент \texttt{alpine}, так как виртуальная машина не позволила раскрыть Evolution и работать на нём :
  \begin{minted}{bash}
    dnf -y install alpine
  \end{minted}
\item Запустили и настроили почтовый клиент alpine (Рис. \ref{12} и \ref{13}):
  \begin{itemize}
  \item в окне настройки учётной записи почты указали имя, адрес почты в виде \break \texttt{ansusenko@ansusenko.net}
 \texttt{mail.ansusenko.net}, в качестве пользователя для входящих и исходящих сообщений указали \texttt{ansusenko};
\end{itemize}
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/10.png}
    \captionof{figure}{Настройка входящих сообщений.}
    \label{12}
\end{center}

\item Из почтового клиента отправили себе несколько тестовых писем и убедились, что они доставлены  (Рис. \ref{14} и \ref{15}).
\begin{center}
    \centering
    \includegraphics[width=\textwidth]{../images/11.png}
    \captionof{figure}{Окно отправки письма.}
    \label{14}
\end{center}
\begin{center}
\item С помощью протокола Telnet просмотрели текст сообщения
    \centering
    \includegraphics[width=\textwidth]{../images/12.png}
    \captionof{figure}{Окнo просмотра полученного письмач через Telnet.}
    \label{15}
\end{center}
\end{enumerate}
\subsection{Внесение изменений в настройки внутреннего окружения виртуальной машины}
\begin{enumerate}

\item На виртуальной машине \texttt{server} перешли в каталог для внесения изменений в настройки внутреннего окружения \texttt{/vagrant/provision/server/}. В соответствующие подкаталоги поместили конфигурационные файлы Dovecot:
\begin{minted}{bash}
  cd /vagrant/provision/server
  mkdir -p /vagrant/provision/server/mail/etc/dovecot/conf.d
  cp -R /etc/dovecot/dovecot.conf /vagrant/provision/server/mail/etc/dovecot/
  cp -R /etc/dovecot/conf.d/10-auth.conf /vagrant/provision/server/mail/etc/dovecot/conf.d/
  cp -R /etc/dovecot/conf.d/auth-system.conf.ext /vagrant/provision/server/mail/etc/dovecot/conf.d/
  cp -R /etc/dovecot/conf.d/10-mail.conf /vagrant/provision/server/mail/etc/dovecot/conf.d/
\end{minted}
\item Внесли изменения в файл \texttt{/vagrant/provision/server/mail.sh}, добавив в него строки:
\begin{itemize}
  \item по установке Dovecot и Telnet;
  \item по настройке межсетевого экрана;
  \item по настройке Postfix в части задания месторасположения почтового ящика;
  \item по перезапуску Postfix и запуску Dovecot.
\end{itemize}
\begin{minted}{bash}
  #!/bin/bash
  echo "Provisioning script $0"
  echo "Install needed packages"
  dnf -y install postfix
  dnf -y install dovecot
  dnf -y install telnet
  echo "Copy configuration files"
  cp -R /vagrant/provision/server/mail/etc/* /etc
  chown -R root:root /etc/postfix
  restorecon -vR /etc
  echo "Configure firewall"
  firewall-cmd --add-service smtp --permanent
  firewall-cmd --add-service pop3 --permanent
  firewall-cmd --add-service pop3s --permanent
  firewall-cmd --add-service imap --permanent
  firewall-cmd --add-service imaps --permanent
  firewall-cmd --add-service smtp-submission --permanent
  firewall-cmd --reload
  echo "Start postfix service"
  systemctl enable postfix
  systemctl start postfix
  echo "Configure postfix"
  postconf -e 'mydomain = user.net'
  postconf -e 'myorigin = $mydomain'
  postconf -e 'inet_protocols = ipv4'
  postconf -e 'inet_interfaces = all'
  postconf -e 'mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain'
  #postconf -e 'mynetworks = 127.0.0.0/8, 192.168.0.0/16'
  echo "Configure postfix for dovecot"
  postconf -e 'home_mailbox = Maildir/'
  echo "Configure postfix for auth"
  postconf -e 'smtpd_sasl_type = dovecot'
  postconf -e 'smtpd_sasl_path = private/auth'
  postconf -e 'smtpd_recipient_restrictions = reject_unknown_recipient_domain, permit_mynetworks, reject_non_fqdn_recipient, reject_unauth_destination, reject_unverified_recipient, permit'
  postconf -e 'mynetworks = 127.0.0.0/8'
  echo "Configure postfix for SMTP over TLS"
  cp /etc/pki/dovecot/certs/dovecot.pem /etc/pki/tls/certs
  cp /etc/pki/dovecot/private/dovecot.pem /etc/pki/tls/private
  postconf -e 'smtpd_tls_cert_file=/etc/pki/tls/certs/dovecot.pem'
  postconf -e 'smtpd_tls_key_file=/etc/pki/tls/private/dovecot.pem'
  postconf -e 'smtpd_tls_session_cache_database = btree:/var/lib/postfix/smtpd_scache'
  postconf -e 'smtpd_tls_security_level = may'
  postconf -e 'smtp_tls_security_level = may'
  postfix set-permissions
  restorecon -vR /etc
  systemctl stop postfix
  systemctl start postfix
  systemctl restart dovecot
\end{minted}
\item На виртуальной машине \texttt{client} в каталоге \texttt{/vagrant/provision/client} скорректировали файл \texttt{mail.sh}, прописав в нём:
\begin{minted}{bash}
  dnf -y install evolution
\end{minted}
\end{enumerate}
\section{Выводы}
В результате выполнения лабораторной работы приобрели практические навыки по установке и простейшему конфигурированию POP3/IMAP-сервера.
\end{document}
